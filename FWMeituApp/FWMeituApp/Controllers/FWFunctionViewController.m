//
//  FWFunctionViewController.m
//  FWMeituApp
//
//  Created by ForrestWoo on 15-9-23.
//  Copyright (c) 2015年 ForrestWoo co,.ltd. All rights reserved.
//



#import "FWFunctionViewController.h"
#import "ConstantsConfig.h"
#import "FWCommonFilter.h"
#import "UIButton+TextAndImageHorizontalDisplay.h"
#import "FWCropView.h"

@interface FWFunctionViewController ()
{
    NSInteger selectedIndex ;
}

@property (nonatomic, assign) NSInteger itemCount;
@property (nonatomic, strong) UIImageView *imageView;
@property (nonatomic, strong) UIImage *currentImage;
@property (nonatomic, strong) FWCropView *cropView;
@end

@implementation FWFunctionViewController

- (id)initWithImage:(UIImage *)image normalImageArr:(NSArray *)normalImageArray highlightedImageArr:(NSArray *)highlightedImageArr textArr:(NSArray *)textArray type:(NSString *)type
{
    if (self = [super init])
    {
        self.normalImageArr = normalImageArray;
        self.hightlightedImageArr = highlightedImageArr;
        self.texts = textArray;
        self.itemCount = [normalImageArray count];
        self.FunctionType = type;
        self.image = image;
    }
    
    return self;
}

- (void)viewDidLoad {
    [super viewDidLoad];
    
    selectedIndex = 0;
    self.view.backgroundColor = [UIColor blackColor];
    
    UILabel *title = [[UILabel alloc] initWithFrame:CGRectMake((WIDTH - kTitleWidth) / 2, 10, kTitleWidth, kTitleHeight)];
    title.text = self.FunctionType;
    [title setFont:[UIFont fontWithName:@"Helvetica-Bold" size:14]];
    title.textColor = [UIColor whiteColor];
    [self.view addSubview:title];
    
    self.imageView = [[UIImageView alloc] initWithImage:self.image];
    CGSize size = self.image.size;
    CGFloat imageWidth = size.width;
    CGFloat imageHeight = size.height;
    CGFloat xPoiont = 0;
    CGFloat yPoint = 64;
    if (imageWidth == 375) {
        yPoint = (460 - imageHeight) / 2.0 + 64;
    }
    if (imageHeight == 460) {
        xPoiont = (375 - imageWidth) / 2.0 ;
    }
    
    self.imageView.frame = CGRectMake(xPoiont, yPoint, 375, 520);
    [self.imageView sizeToFit];
    [self.view addSubview:self.imageView];
    
    UIImage *i1 = [UIImage imageNamed:@"btn_cancel_a@2x.png"];
    self.btnClose = [UIButton buttonWithType:UIButtonTypeCustom];
    [self.btnClose setImage:i1 forState:UIControlStateNormal];
    self.btnClose.frame = CGRectMake(20, HEIGHT - kCancelHeight - 10, kCancelHeight, kCancelHeight);
    [self.btnClose addTarget:self action:@selector(btnCancelOrSaveClicked:) forControlEvents:UIControlEventTouchUpInside];
    [self.view addSubview:self.btnClose];
    
    UIImage *i2 = [UIImage imageNamed:@"btn_ok_a@2x.png"];
    self.btnSave = [UIButton buttonWithType:UIButtonTypeCustom];
    [self.btnSave setImage:i2 forState:UIControlStateNormal];
    self.btnSave.frame = CGRectMake(WIDTH - kCancelHeight - 20, HEIGHT - kCancelHeight - 10, kCancelHeight, kCancelHeight);
    [self.view addSubview:self.btnSave];
    [self.btnSave addTarget:self action:@selector(btnCancelOrSaveClicked:) forControlEvents:UIControlEventTouchUpInside];

    self.typeBar = [[FWEffectBar alloc] initWithFrame:CGRectZero];
    self.typeBar.delegate = self;
    [self.view addSubview:self.typeBar];
    
    self.effectBar = [[FWEffectBar alloc] initWithFrame:CGRectZero];
    self.effectBar.delegate = self;
    [self.view addSubview:self.effectBar];
    
    self.slider = [[UISlider alloc] initWithFrame:CGRectZero];
    self.slider.minimumValue = -100;
    self.slider.maximumValue = 100;
    self.slider.value = 0;
    
    [self.view addSubview:self.slider];
    
}

- (void)updateValue:(id)sender
{
    switch (selectedIndex) {
        case 0:
            self.currentImage = [FWCommonFilter changeValueForBrightnessFilter:self.slider.value image:self.image];
            self.imageView.image = self.currentImage;
            break;
            
        case 1:
            self.currentImage = [FWCommonFilter changeValueForContrastFilter:self.slider.value image:self.image];
            self.imageView.image =   self.currentImage;
            break;
            
        case 2:
            self.currentImage = [FWCommonFilter changeValueForWhiteBalanceFilter:self.slider.value image:self.image];
            self.imageView.image =  self.currentImage;
            break;
            
        case 3:
            self.currentImage = [FWCommonFilter changeValueForHightlightFilter:self.slider.value image:self.image];
            self.imageView.image = self.currentImage;
            break;
            
        case 4:
            self.currentImage = [FWCommonFilter changeValueForHightlightFilter:self.slider.value image:self.image];
            self.imageView.image =   self.currentImage;
            break;
            
        case 5:
            self.currentImage = [FWCommonFilter changeValueForLowlightFilter:self.slider.value image:self.image];
            self.imageView.image =  self.currentImage;
            break;
            
        case 6:
            self.currentImage = [FWCommonFilter changeValueForExposureFilter:self.slider.value image:self.image];
            self.imageView.image =   self.currentImage;
            break;
            
        default:
            break;
    }
}

- (void)setupSliderWithFrame:(CGRect)frame
{
    self.slider.frame = frame;
    [self.slider addTarget:self action:@selector(updateValue:) forControlEvents:UIControlEventValueChanged];
}

- (void)setupEffectBarWithFrame:(CGRect)frame items:(NSArray *)items
{
    self.effectBar.frame = frame;
    
    self.effectBar.items = items;
}

- (void)setupTypeBarWithFrame:(CGRect)frame items:(NSArray *)items
{
    self.typeBar.frame = frame;
    self.typeBar.items = items;
}

- (void)setupButtonsWithFrame:(CGRect)frame
{
    UIButton *btnReset = [UIButton buttonWithType:UIButtonTypeCustom];
    [btnReset setTitle:@"重置" forState:UIControlStateNormal];
    btnReset.frame = CGRectMake(60, HEIGHT - 100, 60, 20);
    [btnReset.titleLabel setFont:[UIFont systemFontOfSize:12.0]];
    [self.view addSubview:btnReset];
    
    UIButton *btnScaleType = [UIButton buttonWithType:UIButtonTypeCustom];
    [btnScaleType setTitle:@"比例：自由" forState:UIControlStateNormal];
    btnScaleType.frame = CGRectMake(140, HEIGHT - 100, 100, 20);
    [btnScaleType.titleLabel setFont:[UIFont systemFontOfSize:12.0]];

    [self.view addSubview:btnScaleType];
    
    UIButton *btnConfirm = [UIButton buttonWithType:UIButtonTypeCustom];
    [btnConfirm setImage:[UIImage imageNamed:@"icon_clip_confim@2x.png"] withTitle:@"确定裁剪" forState:UIControlStateNormal];
    btnConfirm.frame = CGRectMake(240, HEIGHT - 100, 120, 30);
    [self.view addSubview:btnConfirm];
}

- (void)setupImageView
{
    self.imageView.hidden = YES;
    self.cropView = [[FWCropView alloc] initWithFrame:self.imageView.frame];
    [self.cropView setImage:self.image];
//    [self.cropView setupImageView];
    [self.view addSubview:self.cropView];
//    [self.imageView removeFromSuperview];
}

- (void)btnCancelOrSaveClicked:(id)sender
{
    if (sender == self.btnClose) {
        [self dismissViewControllerAnimated:YES completion:^{
            
        }];
    }else if(sender == self.btnSave){
        if ([self.FunctionType isEqualToString:@"编辑"]) {
            UIImageWriteToSavedPhotosAlbum(self.cropView.croppedImage, nil, nil, nil);
            return;
        }
        UIImageWriteToSavedPhotosAlbum(self.currentImage, nil, nil, nil);
    }
}

- (void)didReceiveMemoryWarning {
    [super didReceiveMemoryWarning];
    // Dispose of any resources that can be recreated.
}

- (void)effectBar:(FWEffectBar *)bar didSelectItemAtIndex:(NSInteger)index
{
    selectedIndex =index;
    
    switch (index) {
        case 0:
            self.slider.minimumValue = -1.0;
            self.slider.maximumValue = 1.0;
            self.slider.value = 0.0;
            break;
            
        case 1:
            self.slider.minimumValue = 0.0;
            self.slider.maximumValue = 4.0;
            self.slider.value = 1.0;
            
            break;
            
        case 2:
            self.slider.minimumValue = 1000;
            self.slider.maximumValue = 10000;
            self.slider.value = 5000;
            
            break;
            
        case 3:
            self.slider.minimumValue = 0.0;
            self.slider.maximumValue = 1.0;
            self.slider.value = 0.5;
            break;
            
        case 4:
            self.slider.minimumValue = 0.0;
            self.slider.maximumValue = 1.0;
            self.slider.value = 0.5;
            break;
            
        case 5:
            self.slider.minimumValue = 0.0;
            self.slider.maximumValue = 1.0;
            self.slider.value = 0.5;
            break;
            
        case 6:
            self.slider.minimumValue = -10.0;
            self.slider.maximumValue = 10.0;
            self.slider.value = 0;
            break;
            
        default:
            break;
    }
}

- (void)effectFunc
{
    
}

@end
